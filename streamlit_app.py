import streamlit as st
import streamlit.components.v1 as components
from docx import Document
from docx.shared import Inches
import re
import uuid
import os
import time
import html
import csv
from io import BytesIO

# ----------------------------------------------------
# Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ù† Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ
# ----------------------------------------------------
def render_header():
    if os.path.exists("header.html"):
        with open("header.html", "r", encoding="utf-8") as f:
            header_html = f.read()
        st.markdown(header_html, unsafe_allow_html=True)
    else:
        st.error("âš ï¸ Ù…Ù„Ù 'header.html' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.")

# ----------------------------------------------------
# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
# ----------------------------------------------------
st.set_page_config(
    page_title="Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„ÙŠÙ…Ù†ÙŠØ© Ø¨Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„Ø§ØªÙ‡Ø§ Ø­ØªÙ‰ Ø¹Ø§Ù… 2025Ù…",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ----------------------------------------------------
# Ø«ÙˆØ§Ø¨Øª ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
# ----------------------------------------------------
TRIAL_DURATION = 3 * 24 * 60 * 60  # 3 Ø£ÙŠØ§Ù…
TRIAL_USERS_FILE = "trial_users.txt"
DEVICE_ID_FILE = "device_id.txt"
ACTIVATED_FILE = "activated.txt"
ACTIVATION_CODES_FILE = "activation_codes.txt"
LAWS_DIR = "laws"

# ... (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ø«Ù„ get_device_id, activate_app, highlight_keywords,...)

# ----------------------------------------------------
# Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
# ----------------------------------------------------
def main():
    render_header()  # â† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ù† Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ Ø¨Ø¯Ù„ Ø¥Ø¯Ø±Ø§Ø¬Ù‡ ÙƒÙ†Øµ Ù…Ø¨Ø§Ø´Ø±
    st.divider()

    if is_activated():
        run_main_app()
        return

    st.markdown("<div style='text-align:center; color:#2c3e50; font-size:22px; font-weight:bold; padding:20px;'>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù‚Ù… Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø£Ùˆ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„:</div>", unsafe_allow_html=True)

    # Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
    with st.container(border=True):
        st.markdown("<h3 style='text-align:center; color:#2c3e50;'>â±ï¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</h3>", unsafe_allow_html=True)
        device_id = get_device_id()
        trial_start = get_trial_start(device_id)

        if trial_start is None:
            if st.button("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©", key="start_trial_button", use_container_width=True):
                register_trial(device_id)
                st.success("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.")
                run_main_app()
                st.stop()

        if trial_start is not None:
            elapsed_time = time.time() - trial_start
            remaining_time = int(TRIAL_DURATION - elapsed_time)
            if remaining_time > 0:
                days = remaining_time // 86400
                hours = (remaining_time % 86400) // 3600
                minutes = (remaining_time % 3600) // 60
                seconds = remaining_time % 60
                st.markdown(
                    f"""
                    <div style='background-color:#e3f1fd;border-radius:15px;padding:22px;margin: 0 auto;max-width:450px;text-align:center;'>
                        <span style='font-size:32px;'>&#x23F3;</span>
                        <div style='font-size:20px;color:#2c3e50;margin-bottom:6px;'>
                            Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©.
                        </div>
                        <span style='font-size:19px;color:#185a9d;'>
                            Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <b>{days}</b> ÙŠÙˆÙ… / <b>{hours}</b> Ø³Ø§Ø¹Ø© / <b>{minutes}</b> Ø¯Ù‚ÙŠÙ‚Ø© / <b>{seconds}</b> Ø«Ø§Ù†ÙŠØ©
                        </span>
                    </div>
                    """, unsafe_allow_html=True
                )
                run_main_app()
            else:
                st.error("âŒ Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø². ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….")

    st.markdown("---")

    # Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
    with st.container(border=True):
        st.markdown("<h3 style='text-align:center; color:#2c3e50;'>ğŸ” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</h3>", unsafe_allow_html=True)
        code = st.text_input("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù‡Ù†Ø§:", key="activation_code_input", help="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ Ø­ØµÙ„Øª Ø¹Ù„ÙŠÙ‡ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©.")
        if st.button("âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¢Ù†", key="activate_button", use_container_width=True):
            if code and activate_app(code.strip()):
                st.success("âœ… ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.")
                st.stop()
            else:
                st.error("âŒ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡.")

# ----------------------------------------------------
# Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
# ----------------------------------------------------
if __name__ == "__main__":
    main()
